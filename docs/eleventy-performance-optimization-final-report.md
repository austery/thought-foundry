# Eleventy 性能优化：最终报告

**日期**：2025年12月11日
**状态**：已完成 ✅

## 执行摘要

我们已成功解决了困扰 Thought Foundry 项目的关键构建性能问题和内存崩溃问题。构建时间从 **约 3 小时** 减少到 **约 1.5 分钟**，并且彻底解决了堆内存溢出 (OOM) 错误。

| 指标 | 优化前 | 优化后 | 提升幅度 |
|:---|:---|:---|:---|
| **构建时间** | ~3 小时 (10,925秒) | **88 秒** | **快 99% 以上** |
| **内存占用** | 超过 4GB 并崩溃 | < 1GB 且稳定 | **稳定不崩溃** |
| **Slug 计算次数** | 465,000+ 次 | ~3,000 次 | **减少 99%** |
| **搜索索引大小** | 100MB+ (阻塞部署) | ~10MB (Pagefind) | **体积减少 90%** |

---

## 1. 问题分析

我们确认了两个主要问题：

1.  **指数级的 Slug 计算开销**：`| slug` 过滤器在每次构建中被调用超过 46.5 万次。每次调用都触发昂贵的拼音转换和正则操作，占据了 75% 的构建时间。
2.  **内存分配失败 (OOM)**：大型列表页面（特别是 `all-tags.njk`）试图在单次渲染中处理数千个项目，导致 Node.js 耗尽堆内存（即使分配了 8GB 内存也不够）。

## 2. 实施方案

我们执行了一个多阶段的优化策略：

### ✅ 第一阶段：搜索优化 (Phase 1)
*   **行动**：将臃肿的 JSON 搜索索引替换为 **Pagefind**。
*   **结果**：搜索索引大小从 100MB 降至约 10MB，解决了 GitHub 部署被阻塞的问题，并实现了对中文分词的更好支持。

### ✅ 第二阶段：核心算法优化 (Phase 2)
*   **Slug 缓存**：在 `.eleventy.js` 中实现了全局 `slugCache` Map，用于缓存 Slug 计算的最终结果。
*   **O(1) 查找**：创建了 `lookupSlug` 过滤器，对重复的查找直接返回结果，完全跳过计算。
*   **预计算**：修改了集合生成逻辑（如 `tagList`, `speakerList` 等），在构建时**一次性**计算 Slug，而不是在渲染时计算数千次。
*   **正则优化**：将内联正则表达式替换为预编译常量。

### ✅ 第三阶段：分页（内存修复）(Phase 3)
*   **行动**：在 `src/all-tags.njk` 上实现了分页（每页 50 项）。
*   **原因**：单页渲染 50,000+ 个标签链接是导致 `Ineffective mark-compacts` 内存崩溃的主要原因。
*   **结果**：标签现在分布在 140 多个小页面中，彻底消除了内存峰值。

### ✅ 第四阶段：实体模板深度优化 (Phase 4)
*   **行动**：全面优化了所有 9 个实体详情也模板（包括 `person-page`, `company-org-page`, `tag-page`, `project-page` 等）。
*   **原因**：这些模板在嵌套循环中使用了昂贵的过滤器链（如 `| getUniqueKey | slug`），导致在生成大量实体页面时内存飙升。
*   **修复**：替换为第三阶段引入的优化查找过滤器（如 `| getSpeakerSlug`），消除了动态计算开销。

## 3. 验证与结果

最终构建验证确认了系统的稳定性和速度：
*   **命令**：`npm run build`
*   **耗时**：88.21 秒
*   **缓存表现**：
    *   Slug 缓存命中：507,679 次 (91.2%)
    *   Slug 缓存未命中（唯一值）：49,030 次
*   **产出**：成功生成 38,756 个文件。

## 4. 未来建议

*   **监控 `all-speakers.njk`**：根据您的要求，该页面目前未分页。如果演讲者数量显著增长（>500），可能会再次引发内存累积问题。届时应考虑添加分页。
*   **保留拼音缓存**：确保在 CI/CD 运行之间保留 `.eleventy-cache.json`，以保持构建速度。
*   **使用 `npm run dev`**：对于本地开发，增量构建和开发服务器现在已完全稳定。

---

> 本文档汇总了来自 `performance-issues.md`、`performance-optimization-analysis.md` 和 `OPTIMIZATION_SUMMARY.md` 的早期分析内容。
